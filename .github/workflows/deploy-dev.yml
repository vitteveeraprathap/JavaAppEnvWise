name: Deploy to Container App
on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (v1, v2, v3...)"
        type: string
        required: true
      environment:
        description: "Environment to deploy"
        type: choice
        default: dev
        options:
          - dev
          - uat
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Use GitHub Environments for better security
    environment: ${{ github.event.inputs.environment }}
    env:
      IMAGE_NAME: web-app
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Select ENV values
      id: conf
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "dev" ]]; then
          echo "acr=${{ secrets.DEV_ACR_LOGIN_SERVER }}" >> $GITHUB_OUTPUT
          echo "rg=${{ secrets.RESOURCE_GROUP_DEV }}" >> $GITHUB_OUTPUT
          echo "app=${{ secrets.DEV_CONTAINER_APP }}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event.inputs.environment }}" == "uat" ]]; then
          echo "acr=${{ secrets.UAT_ACR_LOGIN_SERVER }}" >> $GITHUB_OUTPUT
          echo "rg=${{ secrets.UAT_RG }}" >> $GITHUB_OUTPUT
          echo "app=${{ secrets.UAT_CONTAINER_APP }}" >> $GITHUB_OUTPUT
        else
          echo "acr=${{ secrets.PRD_ACR_LOGIN_SERVER }}" >> $GITHUB_OUTPUT
          echo "rg=${{ secrets.PRD_RG }}" >> $GITHUB_OUTPUT
          echo "app=${{ secrets.PRD_CONTAINER_APP }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Deploy to Azure Container App
      run: |
        TAG="${{ github.event.inputs.image_tag }}"
        ACR="${{ steps.conf.outputs.acr }}"
        RG="${{ steps.conf.outputs.rg }}"
        APP_NAME="${{ steps.conf.outputs.app }}"
        IMAGE="${ACR}/${IMAGE_NAME}:${TAG}"
        
        echo "Deploying image: $IMAGE"
        echo "Resource Group: $RG"
        echo "Container App: $APP_NAME"
        
        az containerapp update \
          --name "$APP_NAME" \
          --resource-group "$RG" \
          --image "$IMAGE"
    
    - name: Summary
      run: |
        echo "### ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
