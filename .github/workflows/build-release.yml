name: Build Release (PROD)

on:
  push:
    branches:
      - 'release'
  workflow_dispatch:

env:
  IMAGE_NAME: web-app

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Extract Version (safe tag)
        id: version
        run: |
          # Remove 'refs/heads/' safely and convert any '/' to '-' for a valid docker tag
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SAFE_BRANCH=${BRANCH_NAME//\//-}        # replace slashes with dashes
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)

          # IMAGE_TAG example: release-1.2-abcdef0  or release-a37d568-abcdef0
          IMAGE_TAG="${SAFE_BRANCH}-${SHORT_SHA}"
          RELEASE_VERSION="${SAFE_BRANCH}"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "safe_branch=${SAFE_BRANCH}" >> $GITHUB_OUTPUT

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Log in to PROD Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PROD_ACR_LOGIN_SERVER }}
          username: ${{ secrets.PROD_ACR_USERNAME }}
          password: ${{ secrets.PROD_ACR_PASSWORD }}

      - name: Build & Push to PROD Registry (safe tags)
        run: |
          PROD_REG="${{ secrets.PROD_ACR_LOGIN_SERVER }}"
          IMAGE="${{ env.IMAGE_NAME }}"

          IMAGE_TAG="${{ steps.version.outputs.image_tag }}"
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"

          FULL_IMAGE="${PROD_REG}/${IMAGE}:${IMAGE_TAG}"
          RELEASE_IMAGE="${PROD_REG}/${IMAGE}:${RELEASE_VERSION}"

          echo "Building image: $FULL_IMAGE"
          docker build -t "$FULL_IMAGE" .

          echo "Pushing image: $FULL_IMAGE"
          docker push "$FULL_IMAGE"

          # Also push the release-version tag (branch name)
          docker tag "$FULL_IMAGE" "$RELEASE_IMAGE"
          docker push "$RELEASE_IMAGE"

          # Export for the summary step
          echo "PROD_REG=${PROD_REG}" >> $GITHUB_ENV
          echo "PROD_IMAGE=${IMAGE}:${IMAGE_TAG}" >> $GITHUB_ENV
          echo "PROD_IMAGE_FULL=${FULL_IMAGE}" >> $GITHUB_ENV
          echo "PROD_IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Write PRD-style Build Summary 
        run: |
          # If you prefer to hide the registry, set REG_DISPLAY="***"
          REG="${{ secrets.PRD_ACR_LOGIN_SERVER }}"
          REG_DISPLAY="${REG}"   # change to '***' if you want to mask it

          # Use envs exported earlier
          IMAGE_DISPLAY="${{ env.PRD_IMAGE }}"      # e.g. web-app:uat-se-4567-a95a502
          VERSION_TAG="${{ env.PRD_VERSION_TAG }}"  # e.g. develop-20251122.5

          {
            echo "PRD Image Built Successfully!"
            echo ""
            echo "Registry: ${REG_DISPLAY}"
            echo "Image: ${IMAGE_DISPLAY}"
            echo ""
            echo "Next Step: Go to Actions → Deploy to PRD → Run workflow with tag: ${VERSION_TAG}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Final log (CI)
        run: |
          echo "=== PRD Summary ==="
          cat $GITHUB_STEP_SUMMARY || true

      