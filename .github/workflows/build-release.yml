name: Build Release

on:
  push:
    branches:
      - 'release/*'
  workflow_dispatch:

env:
  IMAGE_NAME: web-app

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract Version
      id: version
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/release/}
        SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
        VERSION="${BRANCH_NAME}-${SHORT_SHA}"
        RELEASE_VERSION="${BRANCH_NAME}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Log in to DEV Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.DEV_ACR_LOGIN_SERVER }}
        username: ${{ secrets.DEV_ACR_USERNAME }}
        password: ${{ secrets.DEV_ACR_PASSWORD }}

    - name: Build and Push to DEV
      run: |
        IMAGE_TAG="${{ steps.version.outputs.version }}"
        RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
        FULL_IMAGE="${{ secrets.DEV_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        
        docker build -t $FULL_IMAGE .
        docker push $FULL_IMAGE
        
        docker tag $FULL_IMAGE ${{ secrets.DEV_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${RELEASE_VERSION}
        docker push ${{ secrets.DEV_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${RELEASE_VERSION}

    - name: Log in to UAT Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.UAT_ACR_LOGIN_SERVER }}
        username: ${{ secrets.UAT_ACR_USERNAME }}
        password: ${{ secrets.UAT_ACR_PASSWORD }}

    - name: Push to UAT
      run: |
        IMAGE_TAG="${{ steps.version.outputs.version }}"
        RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
        DEV_IMAGE="${{ secrets.DEV_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        UAT_IMAGE="${{ secrets.UAT_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        
        docker tag $DEV_IMAGE $UAT_IMAGE
        docker push $UAT_IMAGE
        
        docker tag $UAT_IMAGE ${{ secrets.UAT_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${RELEASE_VERSION}
        docker push ${{ secrets.UAT_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${RELEASE_VERSION}

    - name: Log in to PROD Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.PROD_ACR_LOGIN_SERVER }}
        username: ${{ secrets.PROD_ACR_USERNAME }}
        password: ${{ secrets.PROD_ACR_PASSWORD }}

    - name: Push to PROD
      run: |
        IMAGE_TAG="${{ steps.version.outputs.version }}"
        RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
        DEV_IMAGE="${{ secrets.DEV_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        PROD_IMAGE="${{ secrets.PROD_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        
        docker tag $DEV_IMAGE $PROD_IMAGE
        docker push $PROD_IMAGE
        
        docker tag $PROD_IMAGE ${{ secrets.PROD_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${RELEASE_VERSION}
        docker push ${{ secrets.PROD_ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${RELEASE_VERSION}
        
        echo "### âœ… Release Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release Version:** \`${RELEASE_VERSION}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pushed to ALL registries:**" >> $GITHUB_STEP_SUMMARY
        echo "- DEV: ${{ secrets.DEV_ACR_LOGIN_SERVER }}" >> $GITHUB_STEP_SUMMARY
        echo "- UAT: ${{ secrets.UAT_ACR_LOGIN_SERVER }}" >> $GITHUB_STEP_SUMMARY
        echo "- PROD: ${{ secrets.PROD_ACR_LOGIN_SERVER }}" >> $GITHUB_STEP_SUMMARY