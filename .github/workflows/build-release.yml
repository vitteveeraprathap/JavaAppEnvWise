name: Build Release (PROD)

on:
  push:
    branches:
      - 'release'        # change to 'release/*' if you want any release/* branch
  workflow_dispatch:

env:
  IMAGE_NAME: web-app

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate Version (develop-YYYYMMDD.X)
        id: version
        run: |
          TODAY=$(date +%Y%m%d)
          RUN_NO=${{ github.run_number }}
          VERSION="develop-${TODAY}.${RUN_NO}"
          LATEST_TAG="develop-latest"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Generated VERSION=${VERSION}  LATEST_TAG=${LATEST_TAG}"

      - name: Determine label (e.g. se-4567) & SHORT SHA
        id: meta
        run: |
          # try to extract a label like se-4567 from branch name first, then commit message
          BRANCH="${GITHUB_REF##*/}" || true
          LABEL=$(echo "$BRANCH" | grep -oEi 'se-[0-9]+' || true)

          if [ -z "$LABEL" ]; then
            COMMIT_MSG=$(git log -1 --pretty=%B || true)
            LABEL=$(echo "$COMMIT_MSG" | grep -oEi 'se-[0-9]+' || true)
          fi

          if [ -z "$LABEL" ]; then
            LABEL="unknown"
          fi

          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)

          echo "label=${LABEL}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Log in to PROD Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PROD_ACR_LOGIN_SERVER }}
          username: ${{ secrets.PROD_ACR_USERNAME }}
          password: ${{ secrets.PROD_ACR_PASSWORD }}

      - name: Build & Push to PROD Registry (prod-<label>-<sha> + develop version)
        run: |
          PROD_REG="${{ secrets.PROD_ACR_LOGIN_SERVER }}"
          IMAGE="${{ env.IMAGE_NAME }}"

          VERSION="${{ steps.version.outputs.version }}"
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
          LABEL="${{ steps.meta.outputs.label }}"
          SHORT_SHA="${{ steps.meta.outputs.short_sha }}"

          # Compose tags
          PROD_TAG="prod-${LABEL}-${SHORT_SHA}"           # e.g. prod-se-4567-a95a502
          IMAGE_PROD="${PROD_REG}/${IMAGE}:${PROD_TAG}"
          IMAGE_VERSION="${PROD_REG}/${IMAGE}:${VERSION}"
          IMAGE_LATEST="${PROD_REG}/${IMAGE}:${LATEST_TAG}"

          echo "Building image: $IMAGE_PROD"
          docker build -t "$IMAGE_PROD" .

          echo "Pushing image (PROD tag): $IMAGE_PROD"
          docker push "$IMAGE_PROD"

          # Also tag & push develop version + latest pointer
          docker tag "$IMAGE_PROD" "$IMAGE_VERSION"
          docker push "$IMAGE_VERSION"

          docker tag "$IMAGE_PROD" "$IMAGE_LATEST"
          docker push "$IMAGE_LATEST"

          # Expose env for summary step
          echo "PROD_REG=${PROD_REG}" >> $GITHUB_ENV
          echo "PROD_IMAGE=${IMAGE}:${PROD_TAG}" >> $GITHUB_ENV
          echo "PROD_IMAGE_FULL=${IMAGE_PROD}" >> $GITHUB_ENV
          echo "PROD_VERSION_TAG=${VERSION}" >> $GITHUB_ENV

      - name: Write PROD-style Build Summary (no JIRA ID line)
        run: |
          # If you prefer to hide the registry, set REG_DISPLAY="***"
          REG="${{ secrets.PROD_ACR_LOGIN_SERVER }}"
          REG_DISPLAY="${REG}"   # change to '***' if you want to mask it

          # Use envs exported earlier
          IMAGE_DISPLAY="${{ env.PROD_IMAGE }}"      # e.g. web-app:prod-se-4567-a95a502
          VERSION_TAG="${{ env.PROD_VERSION_TAG }}"  # e.g. develop-20251122.5

          {
            echo "PROD Image Built Successfully!"
            echo ""
            echo "Registry: ${REG_DISPLAY}"
            echo "Image: ${IMAGE_DISPLAY}"
            echo ""
            echo "Next Step: Go to Actions → Deploy to PROD → Run workflow with tag: ${VERSION_TAG}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Final log (CI)
        run: |
          echo "=== PROD Summary ==="
          cat $GITHUB_STEP_SUMMARY || true
