name: Build from Develop (UAT only)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  IMAGE_NAME: web-app

jobs:
  build-and-push-uat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Version (develop-YYYYMMDD.X)
        id: version
        run: |
          TODAY=$(date +%Y%m%d)
          RUN_NO=${{ github.run_number }}
          VERSION="develop-${TODAY}.${RUN_NO}"
          LATEST_TAG="develop-latest"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Generated VERSION=${VERSION}  LATEST_TAG=${LATEST_TAG}"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Log in to UAT Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.UAT_ACR_LOGIN_SERVER }}
          username: ${{ secrets.UAT_ACR_USERNAME }}
          password: ${{ secrets.UAT_ACR_PASSWORD }}

      - name: Build & Push to UAT Registry
        run: |
          UAT_REG="${{ secrets.UAT_ACR_LOGIN_SERVER }}"
          IMAGE="${{ env.IMAGE_NAME }}"

          VERSION="${{ steps.version.outputs.version }}"
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"

          FULL_IMAGE="${UAT_REG}/${IMAGE}:${VERSION}"
          LATEST_IMAGE="${UAT_REG}/${IMAGE}:${LATEST_TAG}"

          echo "Building image: $FULL_IMAGE"
          docker build -t "$FULL_IMAGE" .

          echo "Pushing image: $FULL_IMAGE"
          docker push "$FULL_IMAGE"

          echo "Tagging and pushing latest pointer: $LATEST_IMAGE"
          docker tag "$FULL_IMAGE" "$LATEST_IMAGE"
          docker push "$LATEST_IMAGE"

          # Expose env for downstream steps (if any)
          echo "UAT_IMAGE=${FULL_IMAGE}" >> $GITHUB_ENV
          echo "UAT_IMAGE_TAG=${VERSION}" >> $GITHUB_ENV

          # Add human-friendly step summary
          echo "### âœ… Develop Image Built & Pushed to UAT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Tag:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Latest Tag:** \`${LATEST_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pushed to:** $UAT_REG" >> $GITHUB_STEP_SUMMARY

      - name: Show produced image tag
        run: |
          # Use shell env variables (exported earlier via GITHUB_ENV)
          echo "Image pushed: $UAT_IMAGE"
          echo "Image tag: $UAT_IMAGE_TAG"
